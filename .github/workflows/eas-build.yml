name: Publish EAS Update â€” canary (on push to main)

on:
  push:
    branches: ["main"]

permissions:
  contents: read
  id-token: write

jobs:
  publish-canary:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install deps
        run: npm ci

      - name: Validate EXPO_TOKEN secret
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "${EXPO_TOKEN:-}" ]; then
            echo "âŒ ERROR: EXPO_TOKEN secret is not set. Add it in repository settings -> Secrets."
            exit 1
          fi
          echo "âœ… EXPO_TOKEN is present (redacted)."

      - name: Ensure eas CLI available
        run: |
          set -euo pipefail
          # Try to use npx without installing; if not present, install globally.
          if npx --no-install eas --version >/dev/null 2>&1; then
            echo "âœ… eas (via npx) is available"
          else
            echo "â„¹ï¸ eas not found via npx â€” installing eas-cli globally"
            npm install -g eas-cli@latest
          fi
          eas --version

      - name: Login to EAS (non-interactive)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          set -euo pipefail
          echo "ðŸ” Logging in to EAS..."
          # prefer non-interactive login; whoami will confirm success
          npx eas whoami 2>/dev/null || npx eas login --token "$EXPO_TOKEN"
          npx eas whoami

      - name: Publish EAS update to canary
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          set -euo pipefail
          echo "ðŸš€ Publishing update to canary branch..."
          GIT_SHA=${GITHUB_SHA::8}
          npx eas update --branch canary \
            --message "Auto canary OTA from ${GITHUB_ACTOR} - ${GIT_SHA}" \
            --non-interactive
          echo "âœ… EAS update published."
