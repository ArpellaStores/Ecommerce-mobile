name: EAS Build -> Artifact & Release

on:
  push:
    branches: ["main"]

permissions:
  contents: write
  id-token: write

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate EXPO_TOKEN
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "${EXPO_TOKEN:-}" ]; then
            echo "ERROR: EXPO_TOKEN secret is not set."
            exit 1
          fi

      - name: Ensure eas-cli available
        run: |
          set -euo pipefail
          if ! command -v npx >/dev/null 2>&1; then
            echo "ERROR: npx is not available."
            exit 1
          fi
          if ! npx --no-install eas --version >/dev/null 2>&1; then
            npm install -g eas-cli@latest
          fi
          eas --version

      - name: Start EAS build (android) and wait for completion
        id: eas_build
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          set -euo pipefail

          # verify git working tree is clean
          if [ -n "$(git status --porcelain)" ]; then
            echo "ERROR: Git working tree is dirty. Commit or stash changes and retry."
            git status --porcelain
            exit 1
          fi

          # ensure jq is available
          if ! command -v jq >/dev/null
